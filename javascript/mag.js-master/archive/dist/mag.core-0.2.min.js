/** @name mag.js - Copyright (c) 2013, 2014 Michael Glazer @license MIT @link https://github.com/magnumjs/mag.js */
"use strict";!function(e){var t="warn";window.log=function(){var e=[].shift.apply(arguments),n=Array.prototype.slice.call(arguments);e==t&&console&&console[t](n.join(","))},e.reserved=["__requires","__instance"],e.module=function(t,n){function s(e){var t;if("function"!=typeof e){t=e;var n=t.pop(),s=n.toString(),i=s.substring(s.indexOf("{")+1,s.lastIndexOf("}"));e=new Function(t.join(),i)}return[e,t]}log("info","module name:"+t),this.modules=this.modules||{};var i=this.modules[t];if(i&&(!n||n&&0!=n.length))return i;if(e.inject.namespace=t,e.inject.dependencies[t]={},n){var r=function(t){for(var n=[],s=0,i=t.length;i>s;s++){var r=t[s];if(this.modules[r]){var a=this.modules[r];n.push(a);for(var c in a.services)e.inject.register(c,a.services[c],1);for(var o in a.factories)e.inject.register(o,a.factories[o]())}}}.bind(this);r(n)}return this.modules[t]=new function(){this.name=t,this.directive=function(){},this.config=function(t){e.inject.process(t)},this.service=function(t,n){this.services=this.services||{},this.services[t]=this.services[t]||n,e.inject.register(t,n,1)},this.factory=function(t,n){this.factories=this.factories||{},this.factories[t]=this.factories[t]||n,e.inject.register(t,this.factories[t]())},this.control=function(t,n){this.controls=this.controls||{},e.inject.register("Scope",this.getScope(t));var i=s(n);this.fire("mag.control.process.begin",[t]),e.inject.process(i[0],i[1],0,this,t),this.fire("mag.control.process.end",[t])},this.getScope=function(e){return this.controls=this.controls||{},this.controls[e]=this.controls[e]||{}},this.observers={},this.on=function(e,t){e=e.split(/\s+/);for(var n;n=e.shift();)this.observers[n]||(this.observers[n]=[]),this.observers[n].push(t)},this.fire=function(e,t){if(this.observers[e])for(var n=0;n<this.observers[e].length;n++)this.observers[e][n].apply(this,t)},e.injection(this)}}}(window.mag={}),mag.aspect={injectors:[],namespace:null,add:function(e,t,n){mag.aspect.injectors.push({type:e,name:t,fun:n})},attach:function(){for(var e in mag.aspect.injectors){var t=mag.aspect.injectors[e];mag.aspect[t.type]&&mag.aspect[t.type](t.name,t.fun)}},around:function(e,t){var n=mag.aspect.namespace;for(var s in mag.aspect.namespace)"function"==typeof n[s]&&s.match(e)&&!function(e,n,s){s[n]=function(){return t.call(s,{fn:e,fnName:n,arguments:arguments})}}(n[s],s,n)},before:function(e,t){mag.aspect.around(e,function(e){var n=e.arguments;return t.apply(mag.aspect.namespace,n),mag.aspect.next(e)})},after:function(e,t){mag.aspect.around(e,function(e){var n=e.arguments,s=mag.aspect.next(e);return t.apply(mag.aspect.namespace,n),s})},next:function(e){var t=e.arguments;return e.fn.apply(mag.aspect.namespace,t)}},mag.injection=function(e){mag.aspect.namespace=e,mag.aspect.attach()},mag.inject={namespace:void 0,dependencies:{},waiting:[],findArgs:function(e){if("function"==typeof e){var t=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,n=/,/,s=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,i=e.toString().replace(s,""),r=i.match(t),a=r[1].split(n).map(function(e){return e.trim()});return a}},getInstance:function(e){return this.instances=this.instances||{},this.instances[this.namespace]=this.instances[this.namespace]||{},this.instances[this.namespace][e]?this.instances[this.namespace][e]:void 0},setInstance:function(e,t){this.instances[this.namespace][e]=t},process:function(e,t,n,s,i){function r(e,t,n){function s(){return e.apply(n||this,t)}return s.prototype=e.prototype,new s}var a=this.findArgs(e),c=t||a;if(n){var o=this.getInstance(n);return o?o:(o=r(e,this.getArrayDependencies(c)),this.setInstance(n,o),o)}if(this.isRegistered(c)){var f=e.apply(s,this.getArrayDependencies(c));f&&f.done&&f.done(function(){s.controls[i]})}else{var p={target:e,args:c};this.waiting.push(p)}},isRegistered:function(e){var t=!0;log("info","isRegistered args:",e);for(var n in e){var s=e[n];if(!this.getDependencies()[s]){log("info","Dependency not registered when called:",s),t=!1;break}}return t},getArrayDependencies:function(e){var t=this.getDependencies(),n=this;return e.map(function(e){return t[e]&&t[e].__requires&&(log("info","this dependency has dependencies: "+e),log("info","requires: "+t[e].__requires)),t[e]&&t[e].__instance?n.process(t[e],null,e):t[e]})},getDependencies:function(e){return this.dependencies[e||this.namespace]||{}},register:function(e,t,n){var s=this.findArgs(t);log("info",e+" requires "+s),this.getDependencies()[e]=t,n&&(this.getDependencies()[e].__instance=n),this.getDependencies()[e].__requires=s,this.service()},service:function(){for(var e in this.waiting){var t=this.waiting[e];t&&this.isRegistered(t.args)&&(t.target.apply(t.target,this.getArrayDependencies(t.args)),this.waiting[e]=void 0)}}};
