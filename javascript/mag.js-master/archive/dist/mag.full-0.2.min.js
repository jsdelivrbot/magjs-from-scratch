/** @name mag.js - Copyright (c) 2013, 2014 Michael Glazer @license MIT @link https://github.com/magnumjs/mag.js */
"use strict";!function(e){var t="warn";window.log=function(){var e=[].shift.apply(arguments),n=Array.prototype.slice.call(arguments);e==t&&console&&console[t](n.join(","))},e.reserved=["__requires","__instance"],e.module=function(t,n){function i(e){var t;if("function"!=typeof e){t=e;var n=t.pop(),i=n.toString(),r=i.substring(i.indexOf("{")+1,i.lastIndexOf("}"));e=new Function(t.join(),r)}return[e,t]}log("info","module name:"+t),this.modules=this.modules||{};var r=this.modules[t];if(r&&(!n||n&&0!=n.length))return r;if(e.inject.namespace=t,e.inject.dependencies[t]={},n){var s=function(t){for(var n=[],i=0,r=t.length;r>i;i++){var s=t[i];if(this.modules[s]){var a=this.modules[s];n.push(a);for(var o in a.services)e.inject.register(o,a.services[o],1);for(var c in a.factories)e.inject.register(c,a.factories[c]())}}}.bind(this);s(n)}return this.modules[t]=new function(){this.name=t,this.directive=function(){},this.config=function(t){e.inject.process(t)},this.service=function(t,n){this.services=this.services||{},this.services[t]=this.services[t]||n,e.inject.register(t,n,1)},this.factory=function(t,n){this.factories=this.factories||{},this.factories[t]=this.factories[t]||n,e.inject.register(t,this.factories[t]())},this.control=function(t,n){this.controls=this.controls||{},e.inject.register("Scope",this.getScope(t));var r=i(n);this.fire("mag.control.process.begin",[t]),e.inject.process(r[0],r[1],0,this,t),this.fire("mag.control.process.end",[t])},this.getScope=function(e){return this.controls=this.controls||{},this.controls[e]=this.controls[e]||{}},this.observers={},this.on=function(e,t){e=e.split(/\s+/);for(var n;n=e.shift();)this.observers[n]||(this.observers[n]=[]),this.observers[n].push(t)},this.fire=function(e,t){if(this.observers[e])for(var n=0;n<this.observers[e].length;n++)this.observers[e][n].apply(this,t)},e.injection(this)}}}(window.mag={}),mag.aspect={injectors:[],namespace:null,add:function(e,t,n){mag.aspect.injectors.push({type:e,name:t,fun:n})},attach:function(){for(var e in mag.aspect.injectors){var t=mag.aspect.injectors[e];mag.aspect[t.type]&&mag.aspect[t.type](t.name,t.fun)}},around:function(e,t){var n=mag.aspect.namespace;for(var i in mag.aspect.namespace)"function"==typeof n[i]&&i.match(e)&&!function(e,n,i){i[n]=function(){return t.call(i,{fn:e,fnName:n,arguments:arguments})}}(n[i],i,n)},before:function(e,t){mag.aspect.around(e,function(e){var n=e.arguments;return t.apply(mag.aspect.namespace,n),mag.aspect.next(e)})},after:function(e,t){mag.aspect.around(e,function(e){var n=e.arguments,i=mag.aspect.next(e);return t.apply(mag.aspect.namespace,n),i})},next:function(e){var t=e.arguments;return e.fn.apply(mag.aspect.namespace,t)}},mag.injection=function(e){mag.aspect.namespace=e,mag.aspect.attach()},mag.inject={namespace:void 0,dependencies:{},waiting:[],findArgs:function(e){if("function"==typeof e){var t=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,n=/,/,i=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,r=e.toString().replace(i,""),s=r.match(t),a=s[1].split(n).map(function(e){return e.trim()});return a}},getInstance:function(e){return this.instances=this.instances||{},this.instances[this.namespace]=this.instances[this.namespace]||{},this.instances[this.namespace][e]?this.instances[this.namespace][e]:void 0},setInstance:function(e,t){this.instances[this.namespace][e]=t},process:function(e,t,n,i,r){function s(e,t,n){function i(){return e.apply(n||this,t)}return i.prototype=e.prototype,new i}var a=this.findArgs(e),o=t||a;if(n){var c=this.getInstance(n);return c?c:(c=s(e,this.getArrayDependencies(o)),this.setInstance(n,c),c)}if(this.isRegistered(o)){var h=e.apply(i,this.getArrayDependencies(o));h&&h.done&&h.done(function(){i.controls[r]})}else{var f={target:e,args:o};this.waiting.push(f)}},isRegistered:function(e){var t=!0;log("info","isRegistered args:",e);for(var n in e){var i=e[n];if(!this.getDependencies()[i]){log("info","Dependency not registered when called:",i),t=!1;break}}return t},getArrayDependencies:function(e){var t=this.getDependencies(),n=this;return e.map(function(e){return t[e]&&t[e].__requires&&(log("info","this dependency has dependencies: "+e),log("info","requires: "+t[e].__requires)),t[e]&&t[e].__instance?n.process(t[e],null,e):t[e]})},getDependencies:function(e){return this.dependencies[e||this.namespace]||{}},register:function(e,t,n){var i=this.findArgs(t);log("info",e+" requires "+i),this.getDependencies()[e]=t,n&&(this.getDependencies()[e].__instance=n),this.getDependencies()[e].__requires=i,this.service()},service:function(){for(var e in this.waiting){var t=this.waiting[e];t&&this.isRegistered(t.args)&&(t.target.apply(t.target,this.getArrayDependencies(t.args)),this.waiting[e]=void 0)}}},function(e,t,n,i){function r(e){this.selectorDataKey=c,this.nodeContext=e||i}function s(e){for(var t=e.childNodes,n=[],i=0;i<t.length;i+=1)t[i].nodeType===o&&n.push(t[i]);return n}function a(e,t,n){var i=" "+e.className+" ",r="data-"+n||"bind",s=e.attributes;if(s.length>0)for(var a=0,o=s.length;o>a;a++)if(0===e.attributes[a].nodeName.indexOf(r)){var c=(e.attributes[a].nodeName.indexOf(r),s[a].nodeName.substr(r.length+1));return e.setAttribute("mg-event",c),!0}return e.id===t||i.indexOf(" "+t+" ")>-1||e.name===t||e.nodeName.toLowerCase()===t.toLowerCase()||e.getAttribute(r)===t}var o=1,c="bind";e.domElement=function(e){var t=new r(e);return t},r.prototype.getSelectorDataKey=function(e){return this.selectorDataKey=e||this.selectorDataKey},r.prototype.findElementsByKey=function(e,t){var n=this.matchingElements(t||this.nodeContext,e);return n},r.prototype.findElementsByKeys=function(e,t){var n=[];for(var i in e){var r=this.matchingElements(t||this.nodeContext,i);if(r){var s={key:i,elements:r};n.push(s)}}return n},r.prototype.matchingElements=function(e,t,n){for(var i=s(e),r=[],o=t,c=0;c<i.length;c+=1)a(i[c],o,this.getSelectorDataKey())&&r.push(i[c]);for(var c=0;c<i.length;c++){var h=this.matchingElements(i[c],t,!0);if(h&&h.length>0){r=r.concat(h);break}}return n||r.length?r:!1}}(window.mag=window.mag||{},mag.domElement={},window,document),Object.prototype.watch||Object.defineProperty(Object.prototype,"__watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,t,n){var i=this[e],r=i,s=function(){return r=n.call(this,e,r)},a=function(n){return t.call(this,e,i,n),n};Object.defineProperty?Object.defineProperty(this,e,{get:s,set:a}):Object.prototype.__defineGetter__&&Object.prototype.__defineSetter__&&(Object.prototype.__defineGetter__.call(this,e,s),Object.prototype.__defineSetter__.call(this,e,a))}}),function(e,t,n){e.watch.throttle=function(e,t,n){t||(t=200);var i,r;return function(){var s=n||this,a=+new Date,o=arguments;i&&i+t>a?(clearTimeout(r),r=setTimeout(function(){i=a,e.apply(s,o)},t)):(i=a,e.apply(s,o))}};var i={};i.inQueue=function(e){return this.q=this.q||[],-1!==this.q.indexOf(e)?!0:void this.q.push(e)},e.watch.serve=function(t){function r(e,t){return t==={}||JSON.stringify(e)===JSON.stringify({})||JSON.stringify(e)===JSON.stringify({ignoreKey:n})?!0:!1}var s=this,a=this.getScope(t),o="__requires",c=function(e,n,a){if(log("info","set-"+e,n,a),!r(n,a,o)){log("info",e,n,a);var c=null;for(var h in a)c=a[h],c&&c.done&&!i.inQueue(c)&&c.done(function(i){s.controls[t][h]=i,s.fire("propertyChanged",[e,n,a])});c||s.fire("propertyChanged",[e,n,a])}},h=function(e,t){return log("info","get"+e,t),s.fire("propertyAccessed",arguments),t};this.controls.__watch(t,c,h),this.on("mag.render.end",function(t){e.watch.apply.call(this,a,t)})},e.watch.apply=function(t,n){var i=this,r=e.domElement(e.render.template);for(var s in t){var a=r.findElementsByKey(s);if(a){for(var o=0;o<a.length;o++)if(-1!==["INPUT","TEXTAREA","SELECT"].indexOf(a[o].tagName))var c=a[o];if(c){var h=s,f=function(e){var t=e.srcElement.value;e.stopPropagation&&e.stopPropagation(),null!=e.cancelBubble&&(e.cancelBubble=!0),function(e,t,i){i.controls[n][e]=t,i.fire("propertyChanged",[s,t,t])}(h,t,i)}.bind(this);c._events=c._events||[],-1===c._events.indexOf("bind-change")&&(c.addEventListener("change",e.watch.throttle(f,50),!1),c.addEventListener("input",e.watch.throttle(f,50),!1),c.addEventListener("propertyChange",e.watch.throttle(f,50),!1),c._events.push("bind-change"))}}}},e.aspect.add("before","control",e.watch.serve)}(window.mag=window.mag||{},mag.watch={}),function(e,t){t.server=function(t,n){var i=e.domElement(e.render.template);i.getSelectorDataKey("event");var r=this;for(var s in t){var a=t[s];if("function"==typeof a){var o=i.findElementsByKey(s);if(!o[0])continue;if(o[0]._events=o[0]._events||[],o[0]&&-1===o[0]._events.indexOf(s)){var c=o[0].getAttribute("mg-event");if(c){var h=function(e){if("function"==typeof a){e.stopPropagation&&e.stopPropagation(),null!=e.cancelBubble&&(e.cancelBubble=!0);{(function(e,t,i,r,s){var a=e.bind(i).call(t,s);return r.controls[n],a})(a,this,t,r,e)}}}.bind(this);-1===o[0]._events.indexOf(s+c)&&(o[0].addEventListener(c,h,!1),o[0]._events.push(s+c))}}}}},t.serve=function(t){var n=this.getScope(t);this.on("mag.render.end",function(){e.uiEvent.server.call(this,n,t)})},e.aspect.add("after","control",t.serve)}(window.mag=window.mag||{},mag.uiEvent={}),function(e){function t(e,t){for(;null!==e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}var n=Object.prototype.toString;e.render.serve=function(t){var n=t.arguments,i=n[0],r=e.render.preParser(this,i);if(r){e.aspect.next(t);var s=this.getScope(i),a=this;this.on("propertyChanged",e.watch.throttle(function(){this.count=this.count+1||0,e.render.parse(a,i,s)})),this.on("propertyAccessed",e.watch.throttle(function(){this.count=this.count+1||0,e.render.parse(a,i,s)})),e.render.parse(a,i,s)}},e.render.preParser=function(e,t){log("info","template parse start"+t);var n=document.getElementById(t);if(e.fire("mag.render.begin",[t]),this.templates=this.templates||{},this.templates[t]=this.templates[t]||n?n:0,this.template=this.templates[t],n=this.template,!n||""===this.template)return!1;var i=n.parentNode;return n.parentNode.removeChild(n),this.node=n,this.parent=i,{node:n,parent:i}},e.render.parse=function(i,r,s){if(this.captureCalls=function(e){return this.calls=this.calls||{},this.calls[e]=this.calls[e]||{},this.calls[e].times=this.calls[e].times+1||1,this.calls[e].times},this.node){log("info",r+"-render called: "+this.captureCalls(r));var a=this.node,o=this.parent,c=e.reserved;this.applyVar=function(e,t,n){if(e&&e.nodeType){for(var i in n)if(t===i&&"object"==typeof n[i])return e=e.getElementsByClassName(t),this.applyVars(e[0],n[i]);var r=e.getElementsByClassName(t),s=r.length;for(1>s&&this.setVar(e,t,n);s--;)this.setVar(e,t,n,r,s)}},this.setVar=function(e,n,i,r,s){function a(e,t,n){var i="function"==typeof e[t]?e[t].call(n||this):e[t];return i}function o(e,t,n){if(e.hasChildNodes())for(var i=e.children,r=0,s=i.length;s>r;r++)i[r].firstChild&&(i[r].firstChild.nodeValue?(h(t,i[r],n),f(t,i[r],n)):o(i[r],t,n));else h(t,e,n),f(t,e,n)}function h(e,t,n){function r(e,t,n){e.nodeValue=e.nodeValue.replace(t,function(e,t){return n==t&&-1===c.indexOf(n)?a(i,n):e})}for(var s=0,o=t.attributes,h=o.length;h>s;s++){var f=o.item(s);r(f,e,n)}}function f(e,t,n){t.firstChild.nodeValue=t.firstChild.nodeValue.replace(e,function(e,t){return n==t&&-1===c.indexOf(n)?a(i,n):e})}if(this.pattern=this.pattern||new RegExp("\\[\\[(.*?)\\]\\]","g"),o(e,this.pattern,n),r&&-1===c.indexOf(n)&&-1!==["INPUT","TEXTAREA","SELECT"].indexOf(r[s].tagName)){var u=a(i,n,this);r[s].value=u}else r&&-1===c.indexOf(n)&&t(r[s],a(i,n,this))},this.applyVars=function(e,t){for(var n in t)this.applyVar(e,n,t)},this.parser=function(e,t){for(var i in t)if("[object Array]"===n.call(t[i])){var r=e.getElementsByClassName(i);if(!r[0])return;for(var s=r[0].cloneNode(!0),a=t[i],o=0;o<a.length;o++){{var c=s.cloneNode(!0);a[o]}this.applyVars(c,a[o]),r[0].parentNode.appendChild(c)}r[0].parentNode.removeChild(r[0])}else this.applyVar(e,i,t)},this.parser(a,s),i.fire("mag.render.end",[r]),o.appendChild(a)}},e.aspect.add("around","control",e.render.serve)}(window.mag=window.mag||{},mag.render={});
